<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试任务详情 - 自动化测试平台</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px 0;
        }
        
        .header {
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            padding: 20px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.8rem;
        }
        
        .card, .card-header, .card-body {
            box-sizing: border-box;
        }

        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .card-header {
            background-color: white;
            color: #333;
            border-radius: 10px 10px 0 0 !important;
            border: 1px solid #dee2e6;
            border-bottom: none;
            padding: 15px 20px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .card-body {
            padding: 22px;
            width: 100%;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 10px 10px;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-pending { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status-running { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .status-completed { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status-failed { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .testcase-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .testcase-item:last-child {
            margin-bottom: 0;
        }
        
        .info-row {
            border-bottom: 1px solid #e9ecef;
            padding: 1rem 0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #495057;
        }
        
        .info-value {
            color: #6c757d;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面头部 -->
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0" id="taskName"></h1>
                <div class="d-flex gap-2 ms-auto">
                    <button class="btn btn-outline-secondary btn-sm" onclick="saveTaskConfig()">
                        <i class="bi bi-save me-1"></i>
                        保存配置
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="executeTask()">
                        <i class="bi bi-play-circle me-1"></i>
                        执行任务
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="editTask()">
                        <i class="bi bi-pencil me-1"></i>
                        编辑任务
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="deleteTask()">
                        <i class="bi bi-trash me-1"></i>
                        删除任务
                    </button>
                </div>
            </div>
        </div>

        <div id="loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-3">正在加载任务详情...</p>
        </div>

        <div id="taskDetail" class="d-none">
            <div class="row">
                <!-- 左侧：关联测试用例 -->
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">关联测试用例</h5>
                        </div>
                        <div class="card-body">
                            <div id="taskTestcases" class="row"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧：任务参数 -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">任务参数</h5>
                        </div>
                        <div class="card-body">
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-8 info-value" id="taskId"></div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">模型路径:</div>
                                    <div class="col-md-8 info-value">
                                        <input type="text" class="form-control form-control-sm" id="modelPath" placeholder="请输入模型路径">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">端口号:</div>
                                    <div class="col-md-8 info-value">
                                        <input type="text" class="form-control form-control-sm" id="portNumber" placeholder="请输入端口号">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">测试报告路径:</div>
                                    <div class="col-md-8 info-value">
                                        <input type="text" class="form-control form-control-sm" id="reportPath" placeholder="请输入测试报告路径">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">提示词:</div>
                                    <div class="col-md-8 info-value">
                                        <textarea class="form-control form-control-sm" id="promptText" rows="3" placeholder="请输入提示词"></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">Server命令:</div>
                                    <div class="col-md-8 info-value">
                                        <input type="text" class="form-control form-control-sm" id="serverCommand" placeholder="请输入Server启动命令">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">Server路径:</div>
                                    <div class="col-md-8 info-value">
                                        <input type="text" class="form-control form-control-sm" id="serverPath" placeholder="请输入Server路径">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="info-row">
                                <div class="row">
                                    <div class="col-md-4 info-label">Max Tokens:</div>
                                    <div class="col-md-8 info-value">
                                        <input type="text" class="form-control form-control-sm" id="maxTokens" placeholder="请输入最大token数">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorMessage" class="alert alert-danger d-none" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span id="errorText"></span>
        </div>
        
        <div id="successMessage" class="alert alert-success d-none" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            <span id="successText"></span>
        </div>
        
        <div id="infoMessage" class="alert alert-info d-none" role="alert">
            <i class="bi bi-info-circle me-2"></i>
            <span id="infoText"></span>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTaskId = null;
        let currentTask = null;

        // 页面加载时获取任务名称并加载详情
        document.addEventListener('DOMContentLoaded', async function() {
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('name');
            
            if (taskName) {
                // 先加载testcase.json数据，然后加载任务详情
                await loadTestcaseData();
                loadTaskDetail(taskName);
            } else {
                showError('未找到任务名称');
            }
        });

        // 加载任务详情
        async function loadTaskDetail(taskName) {
            try {
                // 从JSON文件加载参数
                await loadTaskParamsFromJson(taskName);
                
                // 显示任务详情（基于加载的参数）
                displayTaskDetail({
                    name: taskName,
                    configFromJson: currentTask ? currentTask.configFromJson : null
                });
                
            } catch (error) {
                showError('加载任务详情失败: ' + error.message);
            }
        }
        
        // 从JSON文件加载任务参数
        async function loadTaskParamsFromJson(taskName) {
            if (!taskName) return;
            
            try {
                const fileName = `${taskName}.json`;
                const response = await fetch(`/api/load-config?filename=${encodeURIComponent(fileName)}`);
                
                if (response.ok) {
                    const config = await response.json();
                    
                    // 填充任务参数
                    if (config.MODEL_NAME) {
                        document.getElementById('modelPath').value = config.MODEL_NAME;
                    }
                    if (config.port) {
                        document.getElementById('portNumber').value = config.port;
                    }
                    if (config.OUTPUT_DIR) {
                        document.getElementById('reportPath').value = config.OUTPUT_DIR;
                    }
                    if (config.system_words) {
                        document.getElementById('promptText').value = config.system_words;
                    }
                    if (config.server_cmd) {
                        document.getElementById('serverCommand').value = config.server_cmd;
                    }
                    if (config.server_path) {
                        document.getElementById('serverPath').value = config.server_path;
                    }
                    if (config.max_tokens) {
                        document.getElementById('maxTokens').value = config.max_tokens;
                    }
                    
                    // 保存配置到当前任务对象中，用于后续保存操作
                    currentTask = currentTask || {};
                    currentTask.configFromJson = config;
                    
                    // 加载flag=1的测试用例
                    loadFlaggedTestcases(config);
                    
                } else if (response.status !== 404) {
                    console.warn('加载JSON配置文件失败:', response.status);
                }
                // 如果文件不存在（404），则静默失败，使用默认值
                
            } catch (error) {
                console.warn('加载JSON配置文件失败:', error.message);
            }
        }
        
        // 加载flag=1的测试用例
        function loadFlaggedTestcases(config) {
            const flaggedTestcases = [];
            
            // 遍历配置对象，查找flag=1的测试用例
            for (const [key, value] of Object.entries(config)) {
                if (value && typeof value === 'object' && value.flag === 1) {
                    // 从testcase.json中查找对应的测试用例信息
                    const testcaseInfo = window.testcaseData ? window.testcaseData.find(item => item.case === key) : null;
                    
                    flaggedTestcases.push({
                        key: key,
                        name: testcaseInfo ? testcaseInfo.name : key,
                        type: testcaseInfo ? testcaseInfo.type : key,
                        param: value
                    });
                }
            }
            
            // 显示关联测试用例
            displayFlaggedTestcases(flaggedTestcases);
        }
        
        // 显示flag=1的测试用例
        function displayFlaggedTestcases(testcases) {
            const testcasesContainer = document.getElementById('taskTestcases');
            
            if (testcases.length === 0) {
                testcasesContainer.innerHTML = '<p class="text-muted">暂无关联测试用例（JSON文件中没有flag=1的测试用例）</p>';
                return;
            }
            
            let testcasesHTML = '';
            
            testcases.forEach((testcase, index) => {
                // 每两个测试用例开始一个新行
                if (index % 2 === 0) {
                    testcasesHTML += '<div class="row mb-3">';
                }
                
                // 构建参数详情HTML - 所有参数都用可编辑文本框
                let paramsHtml = '';
                
                // 遍历所有参数，为每个参数创建可编辑文本框
                Object.keys(testcase.param).forEach(paramKey => {
                    // 跳过flag、name、type字段，不显示
                    if (paramKey === 'flag' || paramKey === 'name' || paramKey === 'type') return;
                    
                    const paramValue = testcase.param[paramKey];
                    let displayValue = paramValue;
                    
                    // 处理数组类型的参数
                    if (Array.isArray(paramValue)) {
                        displayValue = paramValue.join(',');
                    }
                    
                    paramsHtml += `
                        <div class="row mb-2">
                            <div class="col-md-4"><label class="form-label small mb-0">${paramKey}:</label></div>
                            <div class="col-md-8">
                                <input type="text" class="form-control form-control-sm" 
                                       value="${displayValue}" 
                                       data-testcase="${testcase.key}" 
                                       data-param="${paramKey}">
                            </div>
                        </div>
                    `;
                });
                
                testcasesHTML += `
                    <div class="col-lg-6">
                        <div class="testcase-item card h-100" data-testcase="${testcase.key}">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${testcase.name}</h6>
                                <small class="text-muted">${testcase.type}</small>
                            </div>
                            <div class="card-body">
                                <div class="testcase-params">
                                    ${paramsHtml || '<p class="text-muted">该测试用例无参数配置</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // 每两个测试用例结束一行，或者如果是最后一个测试用例也结束行
                if (index % 2 === 1 || index === testcases.length - 1) {
                    testcasesHTML += '</div>';
                }
            });
            
            testcasesContainer.innerHTML = testcasesHTML;
        }

        // 加载testcase.json数据
        async function loadTestcaseData() {
            try {
                const response = await fetch('/api/load-testcase-data');
                if (response.ok) {
                    window.testcaseData = await response.json();
                } else {
                    console.error('加载testcase.json数据失败');
                    window.testcaseData = [];
                }
            } catch (error) {
                console.error('加载testcase.json数据出错:', error);
                window.testcaseData = [];
            }
        }

        // 显示任务详情
        function displayTaskDetail(task) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('taskDetail').classList.remove('d-none');
            
            document.getElementById('taskName').textContent = task.name;
            document.getElementById('taskId').textContent = task.id;
            
            // 参数已经通过loadTaskParamsFromJson函数从JSON文件加载并填充到表单中
            console.log('任务参数已从JSON文件加载并填充到表单中');
            
            // 测试用例的显示由loadFlaggedTestcases函数处理
            // 这里不需要额外处理，因为测试用例会在参数加载后自动显示
        }



        // 保存任务配置为JSON文件到服务器
        async function saveTaskConfig() {
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('name');
            
            if (!taskName) {
                alert('无法获取任务名称');
                return;
            }
            
            const fileName = `${taskName}.json`;
            
            // 收集任务配置
            const config = {
                MODEL_NAME: document.getElementById('modelPath').value || '',
                OPENAI_BASE_URL: `http://localhost:${document.getElementById('portNumber').value || '8000'}/v1`,
                OUTPUT_DIR: document.getElementById('reportPath').value || 'responses',
                system_words: document.getElementById('promptText').value || '',
                server_cmd: document.getElementById('serverCommand').value || '',
                server_path: document.getElementById('serverPath').value || '',
                port: document.getElementById('portNumber').value || '8000',
                max_tokens: document.getElementById('maxTokens').value ? parseInt(document.getElementById('maxTokens').value) : 8192
            };
            
            // 获取页面上所有测试用例的输入框（这些是flag=1的测试用例）
            const testcaseInputs = document.querySelectorAll('input[data-testcase]');
            
            // 收集页面上显示的测试用例（flag=1）
            const flaggedTestcases = {};
            testcaseInputs.forEach(input => {
                const testcaseKey = input.getAttribute('data-testcase');
                const paramKey = input.getAttribute('data-param');
                
                if (!flaggedTestcases[testcaseKey]) {
                    flaggedTestcases[testcaseKey] = {
                        flag: 1
                    };
                }
                
                let value = input.value;
                
                // 尝试解析JSON格式的值，如果是数组或对象
                try {
                    value = JSON.parse(value);
                } catch {
                    // 如果不是JSON格式，直接使用字符串值
                }
                
                // 确保batch参数是列表格式
                if (paramKey === 'batch' && !Array.isArray(value)) {
                    // 如果是字符串，尝试分割成数组
                    if (typeof value === 'string') {
                        value = value.split(',').map(item => {
                            const num = parseInt(item.trim());
                            return isNaN(num) ? item.trim() : num;
                        });
                    } else {
                        value = [value];
                    }
                }
                
                // 确保batch_and_input_output参数是列表格式
                if (paramKey === 'batch_and_input_output' && !Array.isArray(value)) {
                    // 如果是字符串，尝试分割成数组
                    if (typeof value === 'string') {
                        value = value.split(',').map(item => item.trim());
                    } else {
                        value = [value];
                    }
                }
                
                flaggedTestcases[testcaseKey][paramKey] = value;
            });
            
            // 为所有测试用例设置配置，包括flag=0的测试用例
            if (window.testcaseData && window.testcaseData.length > 0) {
                window.testcaseData.forEach(testcase => {
                    const testcaseKey = testcase.case;
                    
                    // 如果这个测试用例在页面上显示（flag=1），使用页面上的配置
                    if (flaggedTestcases[testcaseKey]) {
                        config[testcaseKey] = flaggedTestcases[testcaseKey];
                    } else {
                        // 否则设置flag=0，并使用默认配置
                        config[testcaseKey] = {
                            flag: 0
                        };
                        
                        // 为flag=0的测试用例设置默认参数值
                        if (testcase.param) {
                            Object.keys(testcase.param).forEach(paramKey => {
                                // 设置默认值
                                if (paramKey === 'batch') {
                                    config[testcaseKey][paramKey] = [1];
                                } else if (paramKey === 'repeatNum') {
                                    config[testcaseKey][paramKey] = 1;
                                } else if (paramKey === 'max_tokens') {
                                    config[testcaseKey][paramKey] = 8192;
                                } else if (paramKey === 'seed') {
                                    config[testcaseKey][paramKey] = "1";
                                } else if (paramKey === 'prompt_path') {
                                    config[testcaseKey][paramKey] = "./prompt/";
                                } else if (paramKey === 'benchmarks_path') {
                                    config[testcaseKey][paramKey] = "./benchmarks/";
                                } else if (paramKey === 'batch_and_input_output') {
                                    config[testcaseKey][paramKey] = ["1-10-10"];
                                } else if (paramKey === 'input_len') {
                                    config[testcaseKey][paramKey] = [14000];
                                } else {
                                    config[testcaseKey][paramKey] = "";
                                }
                            });
                        }
                    }
                });
            }
            
            try {
                // 发送配置到服务器保存
                const response = await fetch('/api/save-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: fileName,
                        config: config
                    })
                });
                
                if (response.ok) {
                    showSuccess(`任务配置已保存为 ${fileName}`);
                } else {
                    throw new Error('保存配置失败');
                }
                
            } catch (error) {
                showError('保存配置失败: ' + error.message);
            }
        }

        // 执行任务
        async function executeTask() {
            // 从URL参数获取任务名称
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('name');
            
            if (!taskName) {
                alert('无法执行任务：任务名称不存在');
                return;
            }
            
            if (!confirm(`确定要执行任务"${taskName}"吗？`)) {
                return;
            }
            
            try {
                // 构建pytest命令
                const command = `config_path=${taskName}.json pytest test_inference.py --html=output_dir/${taskName}/${taskName}.html`;
                
                // 在Linux服务器上执行命令
                const response = await fetch('/api/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: command,
                        task_name: taskName
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`任务"${taskName}"开始执行\n命令: ${command}`);
                    
                    // 更新任务状态为运行中
                    await updateTaskStatus(taskName, 'running');
                    
                    // 重新加载详情
                    loadTaskDetail(currentTaskId);
                } else {
                    throw new Error('执行任务失败');
                }
            } catch (error) {
                alert('执行任务失败: ' + error.message);
            }
        }
        
        // 更新任务状态
        async function updateTaskStatus(taskName, status) {
            try {
                const response = await fetch(`/api/tasks/${encodeURIComponent(taskName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status
                    })
                });
                
                if (!response.ok) {
                    console.error('更新任务状态失败');
                }
            } catch (error) {
                console.error('更新任务状态失败:', error);
            }
        }

        // 编辑任务 - 重新选择测试用例
        function editTask() {
            // 从URL参数获取任务名称
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('name');
            
            if (!taskName) {
                alert('无法编辑任务：任务名称不存在');
                return;
            }
            
            // 创建测试用例选择模态框
            const modalHtml = `
                <div class="modal fade" id="editTaskModal" tabindex="-1" aria-labelledby="editTaskModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editTaskModalLabel">编辑任务 - ${taskName}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">选择测试用例（可多选）:</label>
                                    <div id="testcaseSelection" style="max-height: 400px; overflow-y: auto;">
                                        <div class="text-center py-3">
                                            <div class="spinner-border" role="status">
                                                <span class="visually-hidden">加载中...</span>
                                            </div>
                                            <p class="mt-2">正在加载测试用例...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" onclick="saveTaskTestcases()">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 如果模态框已存在，先移除
            const existingModal = document.getElementById('editTaskModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 添加模态框到页面
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 初始化模态框
            const modal = new bootstrap.Modal(document.getElementById('editTaskModal'));
            modal.show();
            
            // 加载测试用例选择列表
            loadTestcaseSelection();
        }
        
        // 加载测试用例选择列表
        function loadTestcaseSelection() {
            const testcaseSelection = document.getElementById('testcaseSelection');
            
            if (!window.testcases || window.testcases.length === 0) {
                testcaseSelection.innerHTML = '<div class="text-center py-3 text-muted">暂无测试用例数据</div>';
                return;
            }
            
            // 获取当前页面上显示的测试用例（flag=1的测试用例）
            const currentTestcases = [];
            const testcaseItems = document.querySelectorAll('.testcase-item');
            testcaseItems.forEach(item => {
                const testcaseKey = item.getAttribute('data-testcase');
                if (testcaseKey) {
                    currentTestcases.push(testcaseKey);
                }
            });
            
            let html = '';
            window.testcases.forEach(testcase => {
                const isSelected = currentTestcases.includes(testcase.case);
                html += `
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" value="${testcase.case}" id="testcase_${testcase.case}" ${isSelected ? 'checked' : ''}>
                        <label class="form-check-label" for="testcase_${testcase.case}">
                            ${testcase.name} (${testcase.case})
                        </label>
                    </div>
                `;
            });
            
            testcaseSelection.innerHTML = html;
        }
        
        // 保存任务测试用例选择
        async function saveTaskTestcases() {
            // 从URL参数获取任务名称
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('name');
            
            if (!taskName) {
                alert('无法保存测试用例：任务名称不存在');
                return;
            }
            
            // 获取选中的测试用例
            const selectedTestcases = [];
            const checkboxes = document.querySelectorAll('#testcaseSelection .form-check-input:checked');
            checkboxes.forEach(checkbox => {
                selectedTestcases.push(checkbox.value);
            });
            

            if (selectedTestcases.length === 0) {
                alert('请至少选择一个测试用例');
                return;
            }
            
            try {
                // 更新任务测试用例
                const response = await fetch(`/api/tasks/${encodeURIComponent(taskName)}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        testcases: selectedTestcases
                    })
                });
                
                if (response.ok) {
                    const updatedTask = await response.json();
                    
                    // 重新加载页面以显示更新后的测试用例
                    window.location.reload();
                    
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editTaskModal'));
                    modal.hide();
                    
                    showSuccess('测试用例更新成功');
                } else {
                    throw new Error('更新测试用例失败');
                }
            } catch (error) {
                alert('保存测试用例失败: ' + error.message);
            }
        }

        // 删除任务
        async function deleteTask() {
            // 从URL参数获取任务名称
            const urlParams = new URLSearchParams(window.location.search);
            const taskName = urlParams.get('name');
            
            if (!taskName || !confirm('确定要删除这个任务吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${encodeURIComponent(taskName)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    alert('任务删除成功');
                    goBack();
                } else {
                    throw new Error('删除任务失败');
                }
            } catch (error) {
                alert('删除任务失败: ' + error.message);
            }
        }

        // 返回任务列表
        function goBack() {
            window.location.href = '/task';
        }

        // 显示错误信息
        function showError(message) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('taskDetail').classList.add('d-none');
            document.getElementById('errorMessage').classList.remove('d-none');
            document.getElementById('errorText').textContent = message;
        }

        // 显示成功信息
        function showSuccess(message) {
            document.getElementById('errorMessage').classList.add('d-none');
            document.getElementById('infoMessage').classList.add('d-none');
            document.getElementById('successMessage').classList.remove('d-none');
            document.getElementById('successText').textContent = message;
            
            // 3秒后自动隐藏
            setTimeout(() => {
                document.getElementById('successMessage').classList.add('d-none');
            }, 3000);
        }

        // 显示信息提示
        function showInfo(message) {
            document.getElementById('errorMessage').classList.add('d-none');
            document.getElementById('successMessage').classList.add('d-none');
            document.getElementById('infoMessage').classList.remove('d-none');
            document.getElementById('infoText').textContent = message;
            
            // 3秒后自动隐藏
            setTimeout(() => {
                document.getElementById('infoMessage').classList.add('d-none');
            }, 3000);
        }

        // 状态文本转换
        function getStatusText(status) {
            const statusMap = {
                'pending': '待执行',
                'running': '执行中',
                'completed': '已完成',
                'failed': '已失败'
            };
            return statusMap[status] || status;
        }

        // 日期格式化
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // 预加载测试用例数据
        async function loadTestcases() {
            try {
                const response = await fetch('/api/testcases');
                if (response.ok) {
                    window.testcases = await response.json();
                }
            } catch (error) {
                console.error('加载测试用例失败:', error);
            }
        }

        // 页面加载时预加载测试用例
        loadTestcases();
    </script>
</body>
</html>